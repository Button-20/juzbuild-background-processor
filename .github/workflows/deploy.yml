name: Build & Deploy to EC2

on:
  push:
    branches:
      - master
      - main
  pull_request:
    branches:
      - master
      - main
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: button-20/juzbuild-background-processor

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to EC2
        env:
          EC2_PRIVATE_KEY: ${{ secrets.EC2_PRIVATE_KEY }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
          DOCKER_REGISTRY: ${{ env.REGISTRY }}
          IMAGE_NAME: ${{ env.IMAGE_NAME }}
          DOCKER_USERNAME: ${{ github.actor }}
          DOCKER_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          mkdir -p ~/.ssh
          echo "$EC2_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts 2>/dev/null || true

          ssh -i ~/.ssh/id_rsa ${EC2_USER}@${EC2_HOST} << EOFSCRIPT
            set -e
            
            export DOCKER_REGISTRY="$DOCKER_REGISTRY"
            export DOCKER_USERNAME="$DOCKER_USERNAME"
            export DOCKER_PASSWORD="$DOCKER_PASSWORD"
            export IMAGE_NAME="$IMAGE_NAME"
            
            echo "===================================="
            echo "üöÄ Starting deployment to EC2"
            echo "===================================="
            
            # Navigate to app directory
            cd /opt/juzbuild-background-processor || { echo "Directory not found. Run setup script first."; exit 1; }
            
            echo "üì¶ Pulling latest code from GitHub..."
            git pull origin master || git pull origin main
            
            echo "üîê Logging in to Docker registry..."
            echo "$DOCKER_PASSWORD" | docker login "$DOCKER_REGISTRY" -u "$DOCKER_USERNAME" --password-stdin
            
            echo "‚¨áÔ∏è  Pulling latest Docker image..."
            docker pull "$DOCKER_REGISTRY/$IMAGE_NAME:latest"
            
            echo "üõë Stopping system Redis service..."
            sudo systemctl stop redis-server || true
            
            echo "üõë Stopping old containers..."
            docker-compose down || true
            
            echo "üöÄ Starting new containers..."
            docker-compose -f docker-compose.yml up -d
            
            echo "‚è≥ Waiting for service to start..."
            sleep 15
            
            echo "üìã Container status..."
            docker-compose ps
            
            echo "üìã Container logs..."
            docker-compose logs background-processor | tail -20
            
            echo "‚úÖ Health check..."
            RETRY_COUNT=0
            MAX_RETRIES=5
            HEALTH_OK=false
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if curl -v http://localhost:3001/health 2>&1 | grep -q "healthy"; then
                echo "‚úÖ Service is healthy!"
                HEALTH_OK=true
                break
              fi
              RETRY_COUNT=$((RETRY_COUNT+1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "‚è≥ Health check attempt $RETRY_COUNT/$MAX_RETRIES failed, retrying..."
                sleep 5
              fi
            done
            
            if [ "$HEALTH_OK" = false ]; then
              echo "‚ö†Ô∏è  Health check failed after $MAX_RETRIES attempts"
              echo "üìã Full logs:"
              docker-compose logs background-processor
              exit 1
            fi
            
            echo "üßπ Cleaning up old images..."
            docker image prune -f --all --filter "until=72h" || true
            
            echo "===================================="
            echo "‚úÖ Deployment complete!"
            echo "===================================="
          EOFSCRIPT

      - name: Deployment Success
        if: success()
        run: echo "Deployment successful!"

      - name: Deployment Failed
        if: failure()
        run: echo "Deployment failed. Check EC2 logs"
